{"id":"audio_pro-3fi","title":"Hardcoded path construction: electron/main.ts:17,267 uses process.cwd() for tmp dir - breaks if cwd changes or app packaged","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-21T12:07:08.468151-06:00","updated_at":"2025-12-21T12:32:47.033553-06:00","closed_at":"2025-12-21T12:32:47.033553-06:00","close_reason":"Fixed: Replaced process.cwd() with Electron's app.getPath('temp') API. Created getTempDir() helper that uses system temp directory with app-specific subdirectory 'audio-pro-previews'. Works correctly when packaged. Added cleanup handler on app quit to remove preview files. Added 10 test cases verifying temp path behavior and packaging safety."}
{"id":"audio_pro-4dz","title":"Security: electron/main.ts:56-64 appfile protocol handler lacks path traversal protection - validates decode but not directory escape","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-21T12:06:54.952142-06:00","updated_at":"2025-12-21T12:25:10.972279-06:00","closed_at":"2025-12-21T12:25:10.972279-06:00","close_reason":"Fixed: Implemented allowlist-based path validation for appfile:// protocol. Only user-selected and app-generated files can be served. Prevents path traversal attacks. Added 13 test cases covering traversal attempts, URL encoding, and platform-specific bypasses."}
{"id":"audio_pro-503","title":"Performance: electron/main.ts:281-290 audio probe blocks with runFFmpeg instead of ffprobe - inefficient and parses stderr instead of JSON","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T12:07:01.364996-06:00","updated_at":"2025-12-21T13:01:11.439184-06:00","closed_at":"2025-12-21T13:01:11.439184-06:00","close_reason":"Implemented upstream validation and robust probing:\n\n## Path Validation (DW2)\n\nCreated validateMediaPath() helper (electron/main.ts:63-130):\n- Checks path is absolute\n- Verifies file exists (fs.statSync)\n- Confirms file is regular file (not directory)\n- Validates file is readable (fs.accessSync)\n- Enforces extension allowlist (14 supported formats: .mp4, .mov, .mkv, etc.)\n- Returns typed result with clear failure reasons:\n  NOT_ABSOLUTE, NOT_FOUND, NOT_READABLE, NOT_FILE, UNSUPPORTED_TYPE\n\nWired into render-preview IPC (electron/main.ts:688-696):\n- Validates input path BEFORE any FFmpeg/ffprobe execution\n- Fails fast with clear error messages\n- No process spawn on invalid paths\n\n## Robust Probing (503)\n\nReplaced ffmpeg stderr parsing with ffprobe JSON (electron/main.ts:162-205):\n- Uses ffprobe with -print_format json -show_streams -show_format\n- Parses structured JSON (not fragile regex on stderr)\n- Returns FFprobeResult with typed streams and format\n- Much faster (no video decode needed)\n- Deterministic audio stream detection\n\nUpdated render-preview probe (electron/main.ts:722-741):\n- Calls probeMediaMetadata() instead of runFFmpeg()\n- Checks metadata.streams for codec_type === 'audio'\n- Structured error handling for probe failures\n\n## Test Coverage\n\nAdded electron/__tests__/validation.test.ts (16 tests):\n- Absolute path requirements\n- File existence checks\n- File type validation (reject directories)\n- Extension allowlist enforcement (case-insensitive)\n- Readability checks\n- Edge cases: spaces, unicode, special chars\n- Error message quality\n- All 54 tests passing ✓\n\n## Acceptance Criteria Met\n\n✓ No FFmpeg/ffprobe starts with invalid/unreadable path\n✓ All probing uses ffprobe JSON output\n✓ No stderr parsing for metadata remains\n✓ Errors are deterministic and user-actionable\n✓ Validation is comprehensive (existence, type, permissions, extension)\n✓ Fail-fast design prevents wasted work"}
{"id":"audio_pro-5aq","title":"Architecture violation: src/App.tsx:539 lines exceeds 300-line component guideline from CLAUDE.md - split into features/AudioProcessor and features/VideoPreview","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-21T12:07:02.437058-06:00","updated_at":"2025-12-21T12:07:02.437058-06:00"}
{"id":"audio_pro-5fd","title":"Test coverage gap: src/__tests__/app.test.tsx only has smoke tests - no unit tests for FFmpeg filter chain builders in electron/main.ts:97-232","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-21T12:07:06.270894-06:00","updated_at":"2025-12-21T12:07:06.270894-06:00"}
{"id":"audio_pro-8bs","title":"Resource leak: electron/main.ts:234-258 runFFmpeg spawned processes not tracked - no cleanup on app quit or window close","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-21T12:06:58.524441-06:00","updated_at":"2025-12-21T12:55:20.62853-06:00","closed_at":"2025-12-21T12:55:20.62853-06:00","close_reason":"Implemented managed FFmpeg job lifecycle:\n\n1. FFmpegJob abstraction with registry tracking (electron/main.ts:20-31)\n2. Enhanced runFFmpeg() with:\n   - Unique job ID generation\n   - Process registration and deregistration\n   - 5-minute timeout enforcement (configurable)\n   - Guaranteed cleanup on all exit paths (success, error, timeout)\n   - Structured error types (TIMEOUT, CANCELLED, NON_ZERO_EXIT, SPAWN_FAILED)\n\n3. IPC cancellation support via 'cancel-render' handler (electron/main.ts:674-693)\n   - Jobs can be cancelled from UI\n   - Process killed with SIGTERM, escalates to SIGKILL if needed\n   \n4. App lifecycle cleanup (electron/main.ts:173-186)\n   - All active FFmpeg jobs terminated on app quit\n   - Idempotent cleanup, safe to call multiple times\n   \n5. Error handling improvements (electron/main.ts:641-662)\n   - Distinguishes user cancellation, timeout, spawn failure, non-zero exit\n   - Structured FFmpegError interface with type discrimination\n   \n6. Comprehensive test coverage (electron/__tests__/ffmpeg-jobs.test.ts)\n   - 13 tests for job registration, cleanup, timeout, app quit scenarios\n   - All tests passing (38 total across project)\n\nAcceptance criteria met:\n✓ No FFmpeg process exists without being tracked\n✓ No tracked process exits without cleanup\n✓ Cancellation always works\n✓ Timeout always works (5min default)\n✓ App quit leaves zero FFmpeg processes behind"}
{"id":"audio_pro-cn0","title":"Missing error handling: electron/main.ts:234-258 runFFmpeg does not handle spawn timeout or process kill","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-21T12:06:57.58631-06:00","updated_at":"2025-12-21T12:55:20.629378-06:00","closed_at":"2025-12-21T12:55:20.629378-06:00","close_reason":"Implemented managed FFmpeg job lifecycle:\n\n1. FFmpegJob abstraction with registry tracking (electron/main.ts:20-31)\n2. Enhanced runFFmpeg() with:\n   - Unique job ID generation\n   - Process registration and deregistration\n   - 5-minute timeout enforcement (configurable)\n   - Guaranteed cleanup on all exit paths (success, error, timeout)\n   - Structured error types (TIMEOUT, CANCELLED, NON_ZERO_EXIT, SPAWN_FAILED)\n\n3. IPC cancellation support via 'cancel-render' handler (electron/main.ts:674-693)\n   - Jobs can be cancelled from UI\n   - Process killed with SIGTERM, escalates to SIGKILL if needed\n   \n4. App lifecycle cleanup (electron/main.ts:173-186)\n   - All active FFmpeg jobs terminated on app quit\n   - Idempotent cleanup, safe to call multiple times\n   \n5. Error handling improvements (electron/main.ts:641-662)\n   - Distinguishes user cancellation, timeout, spawn failure, non-zero exit\n   - Structured FFmpegError interface with type discrimination\n   \n6. Comprehensive test coverage (electron/__tests__/ffmpeg-jobs.test.ts)\n   - 13 tests for job registration, cleanup, timeout, app quit scenarios\n   - All tests passing (38 total across project)\n\nAcceptance criteria met:\n✓ No FFmpeg process exists without being tracked\n✓ No tracked process exits without cleanup\n✓ Cancellation always works\n✓ Timeout always works (5min default)\n✓ App quit leaves zero FFmpeg processes behind"}
{"id":"audio_pro-dw2","title":"Missing validation: electron/main.ts:261-401 render-preview IPC handler accepts user paths without existence/permission checks before FFmpeg execution","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-21T12:06:59.442761-06:00","updated_at":"2025-12-21T13:01:11.437433-06:00","closed_at":"2025-12-21T13:01:11.437433-06:00","close_reason":"Implemented upstream validation and robust probing:\n\n## Path Validation (DW2)\n\nCreated validateMediaPath() helper (electron/main.ts:63-130):\n- Checks path is absolute\n- Verifies file exists (fs.statSync)\n- Confirms file is regular file (not directory)\n- Validates file is readable (fs.accessSync)\n- Enforces extension allowlist (14 supported formats: .mp4, .mov, .mkv, etc.)\n- Returns typed result with clear failure reasons:\n  NOT_ABSOLUTE, NOT_FOUND, NOT_READABLE, NOT_FILE, UNSUPPORTED_TYPE\n\nWired into render-preview IPC (electron/main.ts:688-696):\n- Validates input path BEFORE any FFmpeg/ffprobe execution\n- Fails fast with clear error messages\n- No process spawn on invalid paths\n\n## Robust Probing (503)\n\nReplaced ffmpeg stderr parsing with ffprobe JSON (electron/main.ts:162-205):\n- Uses ffprobe with -print_format json -show_streams -show_format\n- Parses structured JSON (not fragile regex on stderr)\n- Returns FFprobeResult with typed streams and format\n- Much faster (no video decode needed)\n- Deterministic audio stream detection\n\nUpdated render-preview probe (electron/main.ts:722-741):\n- Calls probeMediaMetadata() instead of runFFmpeg()\n- Checks metadata.streams for codec_type === 'audio'\n- Structured error handling for probe failures\n\n## Test Coverage\n\nAdded electron/__tests__/validation.test.ts (16 tests):\n- Absolute path requirements\n- File existence checks\n- File type validation (reject directories)\n- Extension allowlist enforcement (case-insensitive)\n- Readability checks\n- Edge cases: spaces, unicode, special chars\n- Error message quality\n- All 54 tests passing ✓\n\n## Acceptance Criteria Met\n\n✓ No FFmpeg/ffprobe starts with invalid/unreadable path\n✓ All probing uses ffprobe JSON output\n✓ No stderr parsing for metadata remains\n✓ Errors are deterministic and user-actionable\n✓ Validation is comprehensive (existence, type, permissions, extension)\n✓ Fail-fast design prevents wasted work"}
{"id":"audio_pro-g52","title":"Missing progress reporting: electron/main.ts:234-258 runFFmpeg captures stderr but does not parse FFmpeg progress for UI feedback during long renders","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-21T12:07:09.610868-06:00","updated_at":"2025-12-21T13:33:46.717468-06:00","closed_at":"2025-12-21T13:33:46.717468-06:00","close_reason":"Implemented comprehensive job-level progress reporting for FFmpeg operations.\n\n**Progress Parsing (electron/main.ts:76-105)**\n- parseFFmpegProgress() extracts time from FFmpeg stderr\n- Supports 3 patterns: HH:MM:SS.ms, time=seconds, out_time_ms=microseconds\n- Returns {positionSeconds, rawLine} or null\n\n**Progress Emission (electron/main.ts:115-176)**\n- emitProgress() sends throttled 'job:progress' IPC events (max 10/sec)\n- emitTerminalState() sends final state (completed/failed/cancelled/timed_out)\n- Events include: jobId, status, percent (0-1), positionSeconds, durationSeconds, phase\n\n**FFmpeg Integration (electron/main.ts:833-950)**\n- Enhanced runFFmpeg() to accept durationSeconds and phase parameters\n- Parses stderr line-by-line for progress\n- Emits queued → running → completed/failed/timed_out states\n- tryRenderStrategies() passes duration and phase through\n\n**IPC Bridge (electron/preload.ts:26-33)**\n- Added onJobProgress() to expose progress events to renderer\n- Returns cleanup function to remove listener\n\n**UI Display (src/App.tsx:41-44, 76-97, 172-188, 569-577)**\n- Added progress state: phase, percent, indeterminate\n- useEffect subscribes to 'job:progress' events\n- Status text shows phase and percent during rendering\n- HTML progress bar (determinate when duration known, indeterminate otherwise)\n\n**Tests (electron/__tests__/progress.test.ts)**\n- 22 new tests for parser (all stderr patterns)\n- Tests for percent calculation, clamping, indeterminate mode\n- Tests for throttling behavior\n\n**Results:**\n- All 86 tests passing (64 previous + 22 new)\n- Zero orphaned processes\n- Real-time progress updates in UI\n- Cancellation stops progress immediately\n- Timeout emits timed_out state"}
{"id":"audio_pro-gts","title":"Security: electron/main.ts:43-51 appfile protocol registered with bypassCSP=true - potential XSS risk if renderer serves untrusted content","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-21T12:06:56.38058-06:00","updated_at":"2025-12-21T13:05:20.532815-06:00","closed_at":"2025-12-21T13:05:20.532815-06:00","close_reason":"Removed unnecessary CSP bypass from appfile:// protocol:\n\n## Change Made (electron/main.ts:291-302)\n\nRemoved bypassCSP: true from protocol registration:\n- BEFORE: bypassCSP: true, stream: true, supportFetchAPI: true  \n- AFTER: stream: true, supportFetchAPI: true\n\n## Why CSP Bypass Was Unnecessary\n\nThe bypassCSP privilege is only needed for protocols that:\n1. Execute inline scripts\n2. Load resources that CSP would block\n\nThe appfile:// protocol serves local media files to \u003cvideo\u003e elements:\n- Video src attributes are not affected by CSP script/style restrictions\n- stream + supportFetchAPI are sufficient for video playback with range requests\n- CSP does NOT block media loaded via \u003cvideo src=\"...\"\u003e\n\n## Verification\n\n✓ All 54 tests pass\n✓ App builds successfully  \n✓ No CSP errors in console\n✓ Electron window launches correctly\n✓ Protocol handler still works (serves approved files via allowlist)\n\n## Security Improvement\n\nRemoving bypassCSP eliminates potential XSS risk if renderer were to:\n- Load untrusted content via appfile://\n- Execute scripts from protocol-served files\n- Bypass Content Security Policy protections\n\nCSP now properly enforces on all content, including appfile:// resources.\n\n## Functionality Preserved\n\n- stream: true → Enables streaming for large media files\n- supportFetchAPI: true → Allows fetch() API usage for Range requests  \n- Video playback via \u003cvideo src=\"appfile://...\"\u003e continues to work\n- All existing security validations (path allowlist) remain in place"}
{"id":"audio_pro-hjj","title":"Dead code: .gitignore:3 ignores dist-electron but vite.config.ts:15,29 builds to dist-electron - verify this is intentional for dev workflow","status":"open","priority":3,"issue_type":"chore","created_at":"2025-12-21T12:07:04.280641-06:00","updated_at":"2025-12-21T12:07:04.280641-06:00"}
{"id":"audio_pro-jdi","title":"Temp file accumulation: electron/main.ts:267-268,274-277 creates uniquely named preview files but no automatic cleanup strategy","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-21T12:07:00.238549-06:00","updated_at":"2025-12-21T12:07:00.238549-06:00"}
{"id":"audio_pro-okc","title":"Missing cancellation: electron/main.ts:234-258 runFFmpeg returns Promise but provides no way to cancel in-progress renders from UI","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T12:07:07.395599-06:00","updated_at":"2025-12-21T12:55:20.627133-06:00","closed_at":"2025-12-21T12:55:20.627133-06:00","close_reason":"Implemented managed FFmpeg job lifecycle:\n\n1. FFmpegJob abstraction with registry tracking (electron/main.ts:20-31)\n2. Enhanced runFFmpeg() with:\n   - Unique job ID generation\n   - Process registration and deregistration\n   - 5-minute timeout enforcement (configurable)\n   - Guaranteed cleanup on all exit paths (success, error, timeout)\n   - Structured error types (TIMEOUT, CANCELLED, NON_ZERO_EXIT, SPAWN_FAILED)\n\n3. IPC cancellation support via 'cancel-render' handler (electron/main.ts:674-693)\n   - Jobs can be cancelled from UI\n   - Process killed with SIGTERM, escalates to SIGKILL if needed\n   \n4. App lifecycle cleanup (electron/main.ts:173-186)\n   - All active FFmpeg jobs terminated on app quit\n   - Idempotent cleanup, safe to call multiple times\n   \n5. Error handling improvements (electron/main.ts:641-662)\n   - Distinguishes user cancellation, timeout, spawn failure, non-zero exit\n   - Structured FFmpegError interface with type discrimination\n   \n6. Comprehensive test coverage (electron/__tests__/ffmpeg-jobs.test.ts)\n   - 13 tests for job registration, cleanup, timeout, app quit scenarios\n   - All tests passing (38 total across project)\n\nAcceptance criteria met:\n✓ No FFmpeg process exists without being tracked\n✓ No tracked process exits without cleanup\n✓ Cancellation always works\n✓ Timeout always works (5min default)\n✓ App quit leaves zero FFmpeg processes behind"}
{"id":"audio_pro-qhf","title":"Missing edge case handling: electron/main.ts:305-326,358-391 video copy fallback to re-encode but no fallback if re-encode also fails","status":"closed","priority":3,"issue_type":"bug","created_at":"2025-12-21T12:07:03.518818-06:00","updated_at":"2025-12-21T13:15:21.811059-06:00","closed_at":"2025-12-21T13:15:21.811059-06:00","close_reason":"Implemented deterministic render strategy with comprehensive failure handling:\n\n## Problem Solved\n\nWhen both video copy and re-encode attempts failed, the system would:\n- Only report the last failure\n- Lose context of what was tried\n- Provide generic error messages without actionable guidance\n\n## Changes Made\n\n### 1. Explicit Render Attempts (electron/main.ts:561-667)\n\nCreated typed render attempt system:\n- RenderAttempt interface: name (COPY/REENCODE/LAST_RESORT) + args\n- RenderAttemptFailure: captures attempt name, error, stderr tail\n- tryRenderStrategies(): orchestrates sequential attempts with failure collection\n\n### 2. Comprehensive Failure Collection\n\ntryRenderStrategies() behavior:\n- Try each attempt sequentially (COPY → REENCODE)\n- On NON_ZERO_EXIT: record failure, continue to next attempt\n- On TIMEOUT/CANCELLED/SPAWN_FAILED: fail immediately (no retry)\n- If all attempts fail: throw error with ALL failure details\n\n### 3. User-Actionable Error Diagnosis (electron/main.ts:588-611)\n\ndiagnoseFFmpegFailure() maps stderr patterns to guidance:\n- 'unknown encoder' → Missing codec / build issue\n- 'invalid data found' / 'moov atom' → Corrupt file\n- 'permission denied' → File permission issue\n- 'no space left' → Disk full\n- 'unsupported codec' → Unsupported input codec\n\n### 4. Structured Error Messages\n\nFinal error on complete failure includes:\n- Diagnosis from stderr pattern matching\n- List of all attempts with their specific errors\n- Original stderr for debugging\n- Exit code if available\n\nExample:\n\"All render attempts failed. Missing video codec. FFmpeg may not be built with required encoders.\nAttempts: COPY: codec not supported for copying; REENCODE: encoder libx264 not found\"\n\n### 5. Refactored Render Paths (electron/main.ts:852-940)\n\nBoth original and processed preview renders now use tryRenderStrategies:\n- Original: COPY → REENCODE\n- Processed: COPY (with filters) → REENCODE (with filters)\n- Automatic fallback without manual try/catch\n- Consistent error handling across both paths\n\n### 6. Comprehensive Test Coverage (electron/__tests__/render-strategies.test.ts)\n\n10 new tests covering:\n- COPY succeeds (fast path)\n- COPY fails, REENCODE succeeds (fallback path)\n- Both fail with comprehensive error\n- TIMEOUT/CANCELLED/SPAWN_FAILED propagate immediately\n- Failure details preserved from both attempts\n- User diagnosis messages included\n- All 64 tests passing ✓\n\n## Acceptance Criteria Met\n\n✓ If copy fails and re-encode fails, app returns structured final failure\n✓ Both failures preserved for diagnosis\n✓ No hangs or orphan jobs\n✓ Existing lifecycle/cancel/timeout behavior intact\n✓ User-actionable error messages\n✓ Deterministic behavior (no silent failures)"}
{"id":"audio_pro-uag","title":"Missing dist directory in gitignore: .gitignore missing dist/ folder referenced in vite.config.ts:37 and package.json:38-40","status":"open","priority":3,"issue_type":"chore","created_at":"2025-12-21T12:07:05.360804-06:00","updated_at":"2025-12-21T12:07:05.360804-06:00"}
